<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ä¿¡å¿«æ·å›å¤å·¥å…· - å¾®ä¿¡å¤šæµè§ˆå™¨åŒæ­¥</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        body {
            background: #f5f5f5;
            color: #333;
            min-height: 100vh;
            padding: 8px;
            font-size: 14px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding-bottom: 70px;
        }
        
        header {
            background: white;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        h1 {
            font-size: 16px;
            margin-bottom: 4px;
            color: #07C160;
            text-align: center;
        }
        
        .subtitle {
            font-size: 11px;
            color: #999;
            text-align: center;
        }
        
        .wechat-tips {
            background: #E8F4FD;
            border: 1px solid #BBDEFB;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 12px;
            font-size: 12px;
            color: #1976D2;
            line-height: 1.4;
        }

        .wechat-sync-tips {
            background: #f0f8ff;
            border: 1px solid #d1e7ff;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 12px;
            font-size: 12px;
            color: #1890ff;
        }
        
        .storage-options {
            background: white;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .storage-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }
        
        .storage-info {
            font-size: 11px;
            color: #999;
            margin-top: 2px;
        }
        
        /* æœç´¢åŒºåŸŸä¼˜åŒ– */
        .search-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 10px;
            gap: 3px;
        }
        
        .search-tab {
            flex: 1;
            padding: 8px 10px;
            border: none;
            background: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .search-tab.active {
            background: #07C160;
            color: white;
            box-shadow: 0 1px 4px rgba(7, 193, 96, 0.3);
        }
        
        .search-container {
            background: white;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .search-box input {
            width: 100%;
            border: 1px solid #e8e8e8;
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 14px;
            outline: none;
            background: #fafafa;
            transition: all 0.3s ease;
        }
        
        .search-box input:focus {
            border-color: #07C160;
            background: white;
            box-shadow: 0 0 0 2px rgba(7, 193, 96, 0.1);
        }
        
        .folders-search-box {
            background: white;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: none;
        }
        
        .folders-search-box input {
            width: 100%;
            border: 1px solid #e8e8e8;
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 14px;
            outline: none;
            background: #fafafa;
            transition: all 0.3s ease;
        }
        
        .folders-search-box input:focus {
            border-color: #07C160;
            background: white;
            box-shadow: 0 0 0 2px rgba(7, 193, 96, 0.1);
        }
          
        /* å¿«é€Ÿæ“ä½œä¼˜åŒ– */
        .quick-actions {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
            overflow-x: auto;
            padding: 6px 0;
            -webkit-overflow-scrolling: touch;
        }
        
        .quick-action-btn {
            background: white;
            border: 1px solid #e8e8e8;
            border-radius: 16px;
            padding: 8px 12px;
            font-size: 11px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .quick-action-btn:hover {
            background: #07C160;
            color: white;
            border-color: #07C160;
        }

        .quick-action-btn.active {
            background: #07C160;
            color: white;
            border-color: #07C160;
        }
        
        /* æ–‡ä»¶å¤¹å®¹å™¨ä¼˜åŒ– - å›ºå®šé«˜åº¦åŒºåŸŸ */
        .folders-section {
            margin-bottom: 12px;
            background: white;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            max-height: 180px;
            overflow: hidden;
            position: relative;
        }
        
        .folders-section.expanded {
            max-height: none;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .section-title {
            font-size: 14px;
            color: #333;
            font-weight: 600;
        }
        
        .expand-toggle {
            background: none;
            border: none;
            color: #666;
            font-size: 12px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .expand-toggle:hover {
            background: #f5f5f5;
        }
        
        .folders-container {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 4px 0;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
        }
        
        .folders-container::-webkit-scrollbar {
            height: 4px;
        }
        
        .folders-container::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 2px;
        }
        
        /* æ–‡ä»¶å¤¹æ ·å¼ä¼˜åŒ– - æ›´ç´§å‡‘ */
        .folder {
            background: white;
            border-radius: 8px;
            padding: 10px 12px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1.5px solid transparent;
            position: relative;
            min-width: 100px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .folder:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        }
        
        .folder.active {
            border-color: #07C160;
            background: #f0fff0;
        }
        
        .folder.pinned {
            border-left: 3px solid #FFC107;
            background: #fffbf0;
        }
        
        .folder-color-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .pin-indicator {
            position: absolute;
            top: 6px;
            left: 6px;
            color: #FFC107;
            font-size: 10px;
        }
        
        .folder-name {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 4px;
            color: #333;
            line-height: 1.2;
            padding-right: 12px;
            text-align: center;
        }
        
        .folder-count {
            font-size: 10px;
            color: #666;
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 8px;
            align-self: center;
            text-align: center;
        }
        
        /* æ–°å»ºæ–‡ä»¶å¤¹æŒ‰é’®ä¼˜åŒ– */
        .add-folder-btn {
            background: #f8f9fa;
            border: 1px dashed #ced4da;
            border-radius: 8px;
            padding: 10px 12px;
            min-width: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            flex-shrink: 0;
        }
        
        .add-folder-btn:hover {
            background: #07C160;
            color: white;
            border-color: #07C160;
        }
        
        .add-folder-btn div:first-child {
            font-size: 16px;
            margin-bottom: 2px;
        }
        
        .add-folder-btn div:last-child {
            font-size: 11px;
            font-weight: 500;
        }
        
        /* æ–‡æœ¬å—å®¹å™¨ä¼˜åŒ– */
        .text-blocks-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .text-block {
            background: white;
            border-radius: 10px;
            padding: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .text-block:hover {
            box-shadow: 0 3px 12px rgba(0,0,0,0.12);
        }
        
        .text-block.selected {
            border: 2px solid #07C160;
            background: #f0fff8;
        }
        
        .text-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            cursor: pointer;
            position: relative;
            background: white;
        }
        
        .text-block-title {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            line-height: 1.3;
        }
        
        .checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid #ddd;
            border-radius: 4px;
            display: none; /* é»˜è®¤éšè— */
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .multi-select-mode .checkbox {
            display: flex; /* å¤šé€‰æ¨¡å¼æ—¶æ˜¾ç¤º */
        }
        
        .checkbox.checked {
            background: #07C160;
            border-color: #07C160;
        }
        
        .checkbox.checked::after {
            content: "âœ“";
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .collapse-icon {
            font-size: 10px;
            color: #999;
            transition: transform 0.3s ease;
            min-width: 10px;
        }
        
        .text-block.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }
        
        .text-block-actions {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        
        .action-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            background: #f8f9fa;
            border: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .action-icon:hover {
            background: #e9ecef;
        }
        
        .action-icon.copy {
            color: #07C160;
        }
        
        .action-icon.edit {
            color: #10AEFF;
        }
        
        .text-block-content {
            padding: 15px;
            background: #fafafa;
            font-size: 13px;
            line-height: 1.5;
            color: #555;
            border-top: 1px solid #f0f0f0;
        }
        
        .text-block.collapsed .text-block-content {
            display: none;
        }
        
        .text-block-footer {
            padding: 10px 12px;
            background: #f8f9fa;
            border-top: 1px solid #f0f0f0;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        
        .text-block.collapsed .text-block-footer {
            display: none;
        }
        
        .copy-content-btn, .share-image-btn {
            background: #07C160;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .copy-content-btn:hover, .share-image-btn:hover {
            background: #05a854;
        }
        
        .share-image-btn {
            background: #FF6B35;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .empty-state h3 {
            margin-bottom: 8px;
            color: #999;
            font-weight: 500;
            font-size: 14px;
        }
        
        .empty-state p {
            color: #ccc;
            margin-bottom: 16px;
            font-size: 12px;
        }
        
        /* åº•éƒ¨å·¥å…·æ ä¼˜åŒ– */
        .floating-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 8px 12px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            z-index: 100;
            border-top: 1px solid #f0f0f0;
        }
        
        .floating-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: none;
            border: none;
            padding: 6px 8px;
            border-radius: 8px;
            font-size: 11px;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 50px;
        }
        
        .floating-btn:hover {
            background: #f8f9fa;
        }
        
        .floating-btn.primary {
            color: #07C160;
        }
        
        .floating-btn.image {
            color: #FF6B35;
        }
        
        .floating-btn.secondary {
            color: #10AEFF;
        }
        
        .floating-btn-icon {
            font-size: 18px;
            margin-bottom: 2px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* å¤šé€‰æ“ä½œæ  */
        .multi-select-toolbar {
            position: fixed;
            bottom: 60px;
            left: 0;
            right: 0;
            background: #07C160;
            padding: 12px;
            display: none;
            justify-content: space-between;
            align-items: center;
            z-index: 99;
            color: white;
            font-size: 14px;
            font-weight: 500;
        }
        
        .multi-select-actions {
            display: flex;
            gap: 10px;
        }
        
        .multi-select-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .multi-select-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* æ¨¡æ€æ¡†ä¼˜åŒ– */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 16px;
        }
        
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .modal h2 {
            margin-bottom: 16px;
            font-size: 16px;
            text-align: center;
            color: #333;
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            color: #555;
            font-weight: 500;
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 14px;
            resize: none;
            background: #fafafa;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            border-color: #07C160;
            background: white;
            box-shadow: 0 0 0 2px rgba(7, 193, 96, 0.1);
            outline: none;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .modal-buttons button:first-child {
            background: #f8f9fa;
            color: #666;
        }
        
        .modal-buttons button:first-child:hover {
            background: #e9ecef;
        }
        
        .modal-buttons button:last-child {
            background: #07C160;
            color: white;
        }
        
        .modal-buttons button:last-child:hover {
            background: #05a854;
        }
        
        .copy-success {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 1001;
            font-size: 13px;
            display: none;
        }

        .image-block-indicator {
            background: #FF6B35;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            margin-left: 6px;
            font-weight: 500;
        }

        .more-actions {
            position: relative;
        }
        
        .more-menu {
            display: none;
            position: fixed;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 8px;
            z-index: 1002;
            min-width: 140px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .more-menu button {
            width: 100%;
            padding: 8px 12px;
            border: none;
            background: none;
            text-align: left;
            border-radius: 6px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .more-menu button:hover {
            background: #f5f5f5;
        }
        
        .menu-icon {
            font-size: 14px;
            width: 16px;
            text-align: center;
        }

        /* æ–‡ä»¶å¤¹æ“ä½œèœå• */
        .folder-actions-menu {
            display: none;
            position: fixed;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 8px;
            z-index: 1002;
            min-width: 120px;
        }
        
        .folder-actions-menu button {
            width: 100%;
            padding: 8px 12px;
            border: none;
            background: none;
            text-align: left;
            border-radius: 6px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .folder-actions-menu button:hover {
            background: #f5f5f5;
        }

        /* å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ */
        .image-upload-area {
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            padding: 30px 20px;
            text-align: center;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
        }
        
        .image-upload-area:hover {
            border-color: #07C160;
            background: #f8fff8;
        }
        
        .upload-icon {
            font-size: 32px;
            margin-bottom: 10px;
            color: #999;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 6px;
            margin-top: 10px;
            display: block;
        }

        .share-image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .share-steps {
            text-align: left;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin: 12px 0;
            font-size: 12px;
        }
        
        .share-steps ol {
            margin: 0;
            padding-left: 18px;
        }
        
        .share-steps li {
            margin-bottom: 6px;
        }

        .export-textarea {
            width: 100%;
            height: 200px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px;
            font-size: 12px;
            font-family: monospace;
            resize: none;
            margin-bottom: 10px;
        }
        
        .import-textarea {
            width: 100%;
            height: 150px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px;
            font-size: 12px;
            font-family: monospace;
            resize: none;
            margin-bottom: 10px;
        }

        /* å“åº”å¼ä¼˜åŒ– */
        @media (max-width: 480px) {
            .folders-section {
                max-height: 160px;
            }
            
            .folder {
                min-width: 90px;
                padding: 8px 10px;
            }
            
            .folder-name {
                font-size: 12px;
            }
            
            .add-folder-btn {
                min-width: 90px;
            }
        }
    </style>
</head>
<body>
    <div class="sync-status" id="syncStatus">
        <span class="sync-icon">ğŸ”„</span>
        <span class="sync-text">åŒæ­¥ä¸­...</span>
    </div>

    <div class="container">
        <header>
            <h1>å¾®ä¿¡å¿«æ·å›å¤å·¥å…·</h1>
            <p class="subtitle">å¿«æ·å›å¤è¯æœ¯ä¸å›¾ç‰‡ç®¡ç†</p>
        </header>
        
        <div class="wechat-tips">
            ğŸ’¡ ä½¿ç”¨æç¤ºï¼šæ–‡å­—å†…å®¹å¯ç›´æ¥å¤åˆ¶ï¼Œå›¾ç‰‡å†…å®¹è¯·ä½¿ç”¨"è½¬å‘å›¾ç‰‡"åŠŸèƒ½
        </div>

        <!-- å­˜å‚¨é€‰é¡¹ -->
        <div class="storage-options">
            <div class="storage-option">
                <div>
                    <strong>æœ¬åœ°æ•°æ®å­˜å‚¨</strong>
                    <div class="storage-info">æ‰€æœ‰æ•°æ®ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­</div>
                </div>
                <button id="setupSyncBtn" style="background: #07C160; color: white; padding: 8px 12px; border: none; border-radius: 6px; font-size: 12px; font-weight: 500;">æ•°æ®å¤‡ä»½</button>
            </div>
        </div>
        
        <!-- æœç´¢é€‰é¡¹å¡ -->
        <div class="search-tabs">
            <button class="search-tab active" data-tab="content">æœç´¢å†…å®¹</button>
            <button class="search-tab" data-tab="folders">æœç´¢æ–‡ä»¶å¤¹</button>
        </div>
        
        <!-- å†…å®¹æœç´¢æ¡† -->
        <div class="search-container" id="contentSearchContainer">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="æœç´¢è¯æœ¯æ ‡é¢˜æˆ–å†…å®¹...">
            </div>
        </div>
        
        <!-- æ–‡ä»¶å¤¹æœç´¢æ¡† -->
        <div class="folders-search-box" id="foldersSearchContainer">
            <input type="text" id="foldersSearchInput" placeholder="æœç´¢æ–‡ä»¶å¤¹åç§°...">
        </div>
        
        <!-- å¿«é€Ÿæ“ä½œ - æ›´æ–°åŠŸèƒ½ -->
        <div class="quick-actions">
            <button class="quick-action-btn" id="quickAddFolder">ğŸ“ æ–°å»ºæ–‡ä»¶å¤¹</button>
            <button class="quick-action-btn" id="togglePinFolder">ğŸ“Œ åˆ‡æ¢ç½®é¡¶</button>
            <button class="quick-action-btn" id="editFolderBtn">âœï¸ ä¿®æ”¹æ–‡ä»¶å¤¹</button>
            <button class="quick-action-btn" id="deleteFolderBtn">ğŸ—‘ï¸ åˆ é™¤æ–‡ä»¶å¤¹</button>
            <button class="quick-action-btn" id="multiSelectBtn">â˜‘ï¸ å¼€å¯å¤šé€‰</button>
        </div>
        
        <!-- æ–‡ä»¶å¤¹åŒºåŸŸ - å›ºå®šé«˜åº¦ -->
        <div class="folders-section" id="foldersSection">
            <div class="section-header">
                <div class="section-title">æˆ‘çš„æ–‡ä»¶å¤¹</div>
                <button class="expand-toggle" id="expandToggle">å±•å¼€</button>
            </div>
            <div class="folders-container" id="foldersContainer">
                <!-- "å…¨éƒ¨"æ–‡ä»¶å¤¹ -->
                <div class="folder active" data-folder="all" id="allFolder">
                    <div class="folder-name">å…¨éƒ¨å†…å®¹</div>
                    <div class="folder-count" id="allCount">0</div>
                </div>
                <!-- æ–‡ä»¶å¤¹å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                <div class="add-folder-btn" id="addFolderBtn">
                    <div>+</div>
                    <div>æ–°å»º</div>
                </div>
            </div>
        </div>
        
        <!-- å†…å®¹åŒºåŸŸ -->
        <div class="text-blocks-container" id="blocksContainer">
            <div class="empty-state">
                <h3>è¿˜æ²¡æœ‰å¿«æ·å›å¤å†…å®¹</h3>
                <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹åˆ›å»ºè¯æœ¯æˆ–å›¾ç‰‡</p>
            </div>
        </div>
    </div>
    
    <!-- å¤šé€‰æ“ä½œæ  -->
    <div class="multi-select-toolbar" id="multiSelectToolbar">
        <div class="selected-count">å·²é€‰æ‹© <span id="selectedCount">0</span> é¡¹</div>
        <div class="multi-select-actions">
            <button class="multi-select-btn" id="moveSelectedBtn">ç§»åŠ¨åˆ°æ–‡ä»¶å¤¹</button>
            <button class="multi-select-btn" id="deleteSelectedBtn">åˆ é™¤é€‰ä¸­</button>
            <button class="multi-select-btn" id="cancelSelectBtn">å–æ¶ˆå¤šé€‰</button>
        </div>
    </div>
    
    <!-- åº•éƒ¨å›ºå®šå·¥å…·æ  -->
    <div class="floating-toolbar">
        <button class="floating-btn primary" id="floatingAddBlockBtn">
            <span class="floating-btn-icon">+</span>
            <span>æ–°å»ºè¯æœ¯</span>
        </button>
        <button class="floating-btn image" id="floatingAddImageBtn">
            <span class="floating-btn-icon">ğŸ–¼ï¸</span>
            <span>æ·»åŠ å›¾ç‰‡</span>
        </button>
        <button class="floating-btn" id="floatingImportBtn">
            <span class="floating-btn-icon">ğŸ“¥</span>
            <span>å¯¼å…¥</span>
        </button>
        <button class="floating-btn secondary" id="floatingExportBtn">
            <span class="floating-btn-icon">ğŸ“¤</span>
            <span>å¯¼å‡º</span>
        </button>
    </div>
    
    <!-- æ–‡æœ¬å—æ¨¡æ€æ¡† -->
    <div class="modal" id="blockModal">
        <div class="modal-content">
            <h2 id="modalTitle">æ–°å»ºè¯æœ¯</h2>
            <div class="form-group">
                <label for="blockTitle">è¯æœ¯æ ‡é¢˜</label>
                <input type="text" id="blockTitle" placeholder="ä¾‹å¦‚ï¼šæ¬¢è¿è¯­ã€äº§å“ä»‹ç»...">
            </div>
            <div class="form-group">
                <label for="blockContent">å›å¤å†…å®¹</label>
                <textarea id="blockContent" placeholder="è¯·è¾“å…¥å›å¤å†…å®¹..." rows="4"></textarea>
            </div>
            <div class="form-group">
                <label for="blockFolder">é€‰æ‹©æ–‡ä»¶å¤¹</label>
                <select id="blockFolder"></select>
            </div>
            <div class="modal-buttons">
                <button id="cancelBtn">å–æ¶ˆ</button>
                <button id="saveBtn">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- æ–‡ä»¶å¤¹æ¨¡æ€æ¡† -->
    <div class="modal" id="folderModal">
        <div class="modal-content">
            <h2 id="folderModalTitle">æ–°å»ºæ–‡ä»¶å¤¹</h2>
            <div class="form-group">
                <label for="folderName">æ–‡ä»¶å¤¹åç§°</label>
                <input type="text" id="folderName" placeholder="ä¾‹å¦‚ï¼šæ–°å®¢æˆ·ã€è€å®¢æˆ·...">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="pinFolder"> ç½®é¡¶æ­¤æ–‡ä»¶å¤¹
                </label>
            </div>
            <div class="modal-buttons">
                <button id="cancelFolderBtn">å–æ¶ˆ</button>
                <button id="saveFolderBtn">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡æ¨¡æ€æ¡† -->
    <div class="modal" id="imageModal">
        <div class="modal-content">
            <h2>æ·»åŠ å›¾ç‰‡</h2>
            <div class="form-group">
                <label for="imageTitle">å›¾ç‰‡æ ‡é¢˜</label>
                <input type="text" id="imageTitle" placeholder="ä¾‹å¦‚ï¼šäº§å“å›¾ç‰‡ã€äºŒç»´ç ...">
            </div>
            <div class="form-group">
                <label>ä¸Šä¼ å›¾ç‰‡</label>
                <div class="image-upload-area" id="imageUploadArea">
                    <div class="upload-icon">ğŸ“</div>
                    <div>ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</div>
                    <div style="font-size: 11px; color: #999; margin-top: 5px;">æ”¯æŒ JPGã€PNG æ ¼å¼</div>
                </div>
                <input type="file" id="imageFile" accept="image/*" style="display: none;">
                <div id="imagePreviewContainer" style="display: none;">
                    <img id="imagePreview" class="image-preview" alt="å›¾ç‰‡é¢„è§ˆ">
                </div>
            </div>
            <div class="form-group">
                <label for="imageFolder">é€‰æ‹©æ–‡ä»¶å¤¹</label>
                <select id="imageFolder"></select>
            </div>
            <div class="modal-buttons">
                <button id="cancelImageBtn">å–æ¶ˆ</button>
                <button id="saveImageBtn">ä¿å­˜å›¾ç‰‡</button>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡åˆ†äº«æ¨¡æ€æ¡† -->
    <div class="modal" id="shareModal">
        <div class="modal-content">
            <h2>è½¬å‘å›¾ç‰‡</h2>
            <img id="shareImagePreview" class="share-image-preview" alt="åˆ†äº«å›¾ç‰‡">
            <div class="share-steps">
                <strong>è½¬å‘æ­¥éª¤ï¼š</strong>
                <ol>
                    <li>é•¿æŒ‰ä¸Šæ–¹å›¾ç‰‡</li>
                    <li>é€‰æ‹©"è½¬å‘ç»™æœ‹å‹"</li>
                    <li>æˆ–é€‰æ‹©"ä¿å­˜åˆ°æ‰‹æœº"</li>
                </ol>
            </div>
            <div class="modal-buttons">
                <button id="closeShareBtn" style="flex: 1;">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- å¯¼å‡ºæ¨¡æ€æ¡† -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <h2>å¯¼å‡ºæ•°æ®</h2>
            <div class="form-group">
                <label>å¯¼å‡ºæ•°æ® (å¤åˆ¶æ­¤å†…å®¹ä¿å­˜åˆ°å…¶ä»–åœ°æ–¹)</label>
                <textarea class="export-textarea" id="exportData" readonly></textarea>
            </div>
            <div class="modal-buttons">
                <button id="copyExportBtn" style="background: #07C160; color: white;">å¤åˆ¶æ•°æ®</button>
                <button id="closeExportBtn">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- å¯¼å…¥æ¨¡æ€æ¡† -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <h2>å¯¼å…¥æ•°æ®</h2>
            <div class="form-group">
                <label>ç²˜è´´ä¹‹å‰å¯¼å‡ºçš„æ•°æ®</label>
                <textarea class="import-textarea" id="importData" placeholder="è¯·ç²˜è´´ä¹‹å‰å¯¼å‡ºçš„æ•°æ®..."></textarea>
            </div>
            <div class="modal-buttons">
                <button id="confirmImportBtn" style="background: #07C160; color: white;">ç¡®è®¤å¯¼å…¥</button>
                <button id="closeImportBtn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ–‡ä»¶å¤¹æ“ä½œèœå• -->
    <div class="folder-actions-menu" id="folderActionsMenu">
        <button class="pin-folder-btn">
            <span class="menu-icon">ğŸ“Œ</span>
            ç½®é¡¶æ–‡ä»¶å¤¹
        </button>
        <button class="unpin-folder-btn">
            <span class="menu-icon">ğŸ“</span>
            å–æ¶ˆç½®é¡¶
        </button>
        <button class="rename-folder-btn">
            <span class="menu-icon">âœï¸</span>
            ä¿®æ”¹åç§°
        </button>
        <button class="delete-folder-btn">
            <span class="menu-icon">ğŸ—‘ï¸</span>
            åˆ é™¤æ–‡ä»¶å¤¹
        </button>
    </div>
    
    <div class="copy-success" id="copySuccess">âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿</div>

<script>
    // å­˜å‚¨æ•°æ®
    let textBlocks = JSON.parse(localStorage.getItem('wechatQuickReplies')) || [];
    let folders = JSON.parse(localStorage.getItem('wechatFolders')) || [];
    let editingIndex = -1;
    let currentImageData = null;
    let movingBlockIndex = -1;
    let editingFolderId = null;
    let currentActiveFolder = 'all';
    let selectedFolderId = null;
    let selectedBlocks = new Set(); // å¤šé€‰åŠŸèƒ½
    let isMultiSelectMode = false; // å¤šé€‰æ¨¡å¼

    // åˆå§‹åŒ–
    function init() {
        renderFolders();
        renderBlocks();
        setupEventListeners();
        updateFolderSelects();
        setupAllFolderClick();
        
        // æ·»åŠ æ–‡ä»¶å¤¹æœç´¢äº‹ä»¶ç›‘å¬
        document.getElementById('foldersSearchInput').addEventListener('input', renderFolders);
    }

    // è®¾ç½®"å…¨éƒ¨"æ–‡ä»¶å¤¹ç‚¹å‡»äº‹ä»¶
    function setupAllFolderClick() {
        const allFolder = document.getElementById('allFolder');
        if (allFolder) {
            allFolder.addEventListener('click', function() {
                setActiveFolder('all');
            });
        }
    }

    // è®¾ç½®æ´»åŠ¨æ–‡ä»¶å¤¹
    function setActiveFolder(folderId) {
        currentActiveFolder = folderId;
        
        // ç§»é™¤æ‰€æœ‰æ–‡ä»¶å¤¹çš„activeç±»
        document.querySelectorAll('.folder').forEach(f => {
            f.classList.remove('active');
        });
        
        // æ·»åŠ å½“å‰æ–‡ä»¶å¤¹çš„activeç±»
        const targetFolder = document.querySelector(`[data-folder="${folderId}"]`);
        if (targetFolder) {
            targetFolder.classList.add('active');
        }
        
        // æ¸²æŸ“å¯¹åº”æ–‡ä»¶å¤¹çš„å†…å®¹
        renderBlocks();
    }

    // æ¸²æŸ“æ–‡ä»¶å¤¹
    function renderFolders() {
        const foldersContainer = document.getElementById('foldersContainer');
        const searchTerm = document.getElementById('foldersSearchInput').value.toLowerCase();
        
        // ä¿ç•™"å…¨éƒ¨"æ–‡ä»¶å¤¹å’Œ"æ–°å»º"æŒ‰é’®
        const allFolder = document.getElementById('allFolder');
        const addBtn = document.getElementById('addFolderBtn');
        
        // æ¸…ç©ºæ–‡ä»¶å¤¹å®¹å™¨
        foldersContainer.innerHTML = '';
        
        // é‡æ–°æ·»åŠ "å…¨éƒ¨"æ–‡ä»¶å¤¹
        foldersContainer.appendChild(allFolder);
        
        // å…ˆæ˜¾ç¤ºç½®é¡¶æ–‡ä»¶å¤¹ï¼Œå†æ˜¾ç¤ºæ™®é€šæ–‡ä»¶å¤¹
        const pinnedFolders = folders.filter(folder => folder.pinned);
        const normalFolders = folders.filter(folder => !folder.pinned);
        const sortedFolders = [...pinnedFolders, ...normalFolders];
        
        // æ·»åŠ æ–‡ä»¶å¤¹
        sortedFolders.forEach(folder => {
            // æ ¹æ®æœç´¢è¯ç­›é€‰æ–‡ä»¶å¤¹
            if (searchTerm && !folder.name.toLowerCase().includes(searchTerm)) {
                return;
            }
            
            const folderEl = document.createElement('div');
            folderEl.className = `folder ${folder.id === currentActiveFolder ? 'active' : ''} ${folder.pinned ? 'pinned' : ''}`;
            folderEl.dataset.folder = folder.id;
            
            folderEl.innerHTML = `
                ${folder.pinned ? '<div class="pin-indicator">ğŸ“Œ</div>' : ''}
                <div class="folder-color-indicator" style="background: ${folder.color || '#07C160'}"></div>
                <div class="folder-name">${folder.name}</div>
                <div class="folder-count">${getFolderBlockCount(folder.id)}</div>
            `;
            
            folderEl.addEventListener('click', function(e) {
                if (e.target.closest('.folder-actions-menu')) return;
                setActiveFolder(folder.id);
            });
            
            // é•¿æŒ‰æ˜¾ç¤ºæ“ä½œèœå•
            let longPressTimer;
            folderEl.addEventListener('touchstart', (e) => {
                longPressTimer = setTimeout(() => {
                    showFolderActionsMenu(e, folder.id);
                }, 500);
            });
            
            folderEl.addEventListener('touchend', () => {
                clearTimeout(longPressTimer);
            });
            
            folderEl.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showFolderActionsMenu(e, folder.id);
            });
            
            foldersContainer.appendChild(folderEl);
        });
        
        // é‡æ–°æ·»åŠ "æ–°å»º"æŒ‰é’®
        foldersContainer.appendChild(addBtn);
        
        // æ›´æ–°"å…¨éƒ¨"æ–‡ä»¶å¤¹è®¡æ•°
        updateAllFolderCount();
    }

    // è·å–æ–‡ä»¶å¤¹ä¸­çš„æ–‡æœ¬å—æ•°é‡
    function getFolderBlockCount(folderId) {
        if (folderId === 'all') return textBlocks.length;
        return textBlocks.filter(block => block.folder === folderId).length;
    }

    // æ›´æ–°"å…¨éƒ¨"æ–‡ä»¶å¤¹è®¡æ•°
    function updateAllFolderCount() {
        const allCount = document.getElementById('allCount');
        if (allCount) {
            allCount.textContent = textBlocks.length;
        }
    }

    // æ˜¾ç¤ºæ–‡ä»¶å¤¹æ“ä½œèœå•
    function showFolderActionsMenu(e, folderId) {
        selectedFolderId = folderId;
        const folder = folders.find(f => f.id === folderId);
        if (!folder) return;
        
        const menu = document.getElementById('folderActionsMenu');
        const rect = e.target.getBoundingClientRect();
        
        // æ›´æ–°èœå•æŒ‰é’®çŠ¶æ€
        const pinBtn = menu.querySelector('.pin-folder-btn');
        const unpinBtn = menu.querySelector('.unpin-folder-btn');
        
        if (folder.pinned) {
            pinBtn.style.display = 'none';
            unpinBtn.style.display = 'flex';
        } else {
            pinBtn.style.display = 'flex';
            unpinBtn.style.display = 'none';
        }
        
        menu.style.display = 'block';
        menu.style.top = `${rect.bottom + 5}px`;
        menu.style.left = `${rect.left}px`;
    }

    // ç½®é¡¶æ–‡ä»¶å¤¹
    function pinFolder(folderId) {
        const folder = folders.find(f => f.id === folderId);
        if (folder) {
            folder.pinned = true;
            saveData();
            renderFolders();
            showCopySuccess(`"${folder.name}"å·²ç½®é¡¶`);
        }
        closeFolderActionsMenu();
    }

    // å–æ¶ˆç½®é¡¶
    function unpinFolder(folderId) {
        const folder = folders.find(f => f.id === folderId);
        if (folder) {
            folder.pinned = false;
            saveData();
            renderFolders();
            showCopySuccess(`"${folder.name}"å·²å–æ¶ˆç½®é¡¶`);
        }
        closeFolderActionsMenu();
    }

    // åˆ‡æ¢ç½®é¡¶çŠ¶æ€
    function togglePinFolder(folderId) {
        const folder = folders.find(f => f.id === folderId);
        if (folder) {
            folder.pinned = !folder.pinned;
            saveData();
            renderFolders();
            showCopySuccess(folder.pinned ? `"${folder.name}"å·²ç½®é¡¶` : `"${folder.name}"å·²å–æ¶ˆç½®é¡¶`);
        }
    }

    // é‡å‘½åæ–‡ä»¶å¤¹
    function renameFolder(folderId) {
        const folder = folders.find(f => f.id === folderId);
        if (folder) {
            editingFolderId = folderId;
            document.getElementById('folderName').value = folder.name;
            document.getElementById('pinFolder').checked = folder.pinned;
            document.getElementById('folderModalTitle').textContent = 'ä¿®æ”¹æ–‡ä»¶å¤¹åç§°';
            document.getElementById('folderModal').style.display = 'flex';
        }
        closeFolderActionsMenu();
    }

    // åˆ é™¤æ–‡ä»¶å¤¹
    function deleteSelectedFolder() {
        if (!selectedFolderId) return;
        
        const folder = folders.find(f => f.id === selectedFolderId);
        if (!folder) return;
        
        const folderBlocks = textBlocks.filter(block => block.folder === selectedFolderId);
        if (folderBlocks.length > 0) {
            if (!confirm(`æ–‡ä»¶å¤¹"${folder.name}"ä¸­åŒ…å«${folderBlocks.length}æ¡å†…å®¹ï¼Œç¡®å®šè¦åˆ é™¤å—ï¼Ÿåˆ é™¤åå†…å®¹å°†ç§»åŠ¨åˆ°"å…¨éƒ¨"æ–‡ä»¶å¤¹ã€‚`)) {
                closeFolderActionsMenu();
                return;
            }
        }
        
        // åˆ é™¤æ–‡ä»¶å¤¹
        folders = folders.filter(f => f.id !== selectedFolderId);
        
        // å°†è¯¥æ–‡ä»¶å¤¹ä¸­çš„å†…å®¹ç§»åŠ¨åˆ°é»˜è®¤æ–‡ä»¶å¤¹
        textBlocks.forEach(block => {
            if (block.folder === selectedFolderId) {
                block.folder = 'all';
            }
        });
        
        saveData();
        renderFolders();
        renderBlocks();
        updateFolderSelects();
        showCopySuccess(`"${folder.name}"æ–‡ä»¶å¤¹å·²åˆ é™¤`);
        closeFolderActionsMenu();
    }

    // å…³é—­æ–‡ä»¶å¤¹æ“ä½œèœå•
    function closeFolderActionsMenu() {
        document.getElementById('folderActionsMenu').style.display = 'none';
        selectedFolderId = null;
    }

    // æ¸²æŸ“æ–‡æœ¬å—
    function renderBlocks() {
        const blocksContainer = document.getElementById('blocksContainer');
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        
        // ç­›é€‰æ–‡æœ¬å—
        let filteredBlocks = textBlocks;
        
        // æŒ‰æ–‡ä»¶å¤¹ç­›é€‰
        if (currentActiveFolder !== 'all') {
            filteredBlocks = filteredBlocks.filter(block => block.folder === currentActiveFolder);
        }
        
        // æŒ‰æœç´¢è¯ç­›é€‰
        if (searchTerm) {
            filteredBlocks = filteredBlocks.filter(block => 
                block.title.toLowerCase().includes(searchTerm) || 
                (block.content && typeof block.content === 'string' && block.content.toLowerCase().includes(searchTerm))
            );
        }
        
        if (filteredBlocks.length === 0) {
            if (textBlocks.length === 0) {
                blocksContainer.innerHTML = `
                    <div class="empty-state">
                        <h3>è¿˜æ²¡æœ‰å¿«æ·å›å¤å†…å®¹</h3>
                        <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹åˆ›å»ºè¯æœ¯æˆ–å›¾ç‰‡</p>
                    </div>
                `;
            } else if (searchTerm) {
                blocksContainer.innerHTML = `
                    <div class="empty-state">
                        <h3>æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å†…å®¹</h3>
                        <p>å°è¯•ä¿®æ”¹æœç´¢è¯æˆ–é€‰æ‹©å…¶ä»–æ–‡ä»¶å¤¹</p>
                    </div>
                `;
            } else {
                const folderName = currentActiveFolder === 'all' ? 'å…¨éƒ¨' : 
                    folders.find(f => f.id === currentActiveFolder)?.name || 'è¯¥æ–‡ä»¶å¤¹';
                blocksContainer.innerHTML = `
                    <div class="empty-state">
                        <h3>${folderName}ä¸­æ²¡æœ‰å†…å®¹</h3>
                        <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ å†…å®¹ï¼Œæˆ–é€‰æ‹©å…¶ä»–æ–‡ä»¶å¤¹</p>
                    </div>
                `;
            }
            return;
        }
        
        blocksContainer.innerHTML = '';
        
        filteredBlocks.forEach((block, index) => {
            const originalIndex = textBlocks.findIndex(b => b.id === block.id);
            const blockEl = createBlockElement(block, originalIndex);
            blocksContainer.appendChild(blockEl);
        });
        
        // æ›´æ–°å¤šé€‰UIçŠ¶æ€
        updateMultiSelectUI();
    }

    // åˆ›å»ºæ–‡æœ¬å—å…ƒç´ 
    function createBlockElement(block, index) {
        const blockElement = document.createElement('div');
        blockElement.className = 'text-block collapsed'; // é»˜è®¤æŠ˜å çŠ¶æ€
        blockElement.dataset.blockId = block.id; // ä½¿ç”¨å”¯ä¸€ID
        
        const isImageBlock = block.type === 'image';
        const isSelected = selectedBlocks.has(block.id); // ä½¿ç”¨block.idè€Œä¸æ˜¯index
        
        blockElement.innerHTML = `
            <div class="text-block-header">
                <div class="text-block-title">
                    <div class="checkbox ${isSelected ? 'checked' : ''}" data-block-id="${block.id}"></div>
                    <span class="collapse-icon">â–¼</span>
                    ${block.title}
                    ${isImageBlock ? '<span class="image-block-indicator">å›¾ç‰‡</span>' : ''}
                </div>
                <div class="text-block-actions">
                    <button class="action-icon copy" title="${isImageBlock ? 'åˆ†äº«å›¾ç‰‡' : 'å¤åˆ¶å†…å®¹'}">
                        ${isImageBlock ? 'ğŸ–¼ï¸' : 'ğŸ“‹'}
                    </button>
                    <button class="action-icon edit" title="ç¼–è¾‘">
                        âœï¸
                    </button>
                    <div class="more-actions">
                        <button class="action-icon more" title="æ›´å¤šæ“ä½œ">
                            â‹®
                        </button>
                        <div class="more-menu">
                            <button class="move-top-btn">
                                <span class="menu-icon">â¬†ï¸</span>
                                ç½®é¡¶
                            </button>
                            <button class="move-up-btn">
                                <span class="menu-icon">â†‘</span>
                                ä¸Šç§»
                            </button>
                            <button class="move-down-btn">
                                <span class="menu-icon">â†“</span>
                                ä¸‹ç§»
                            </button>
                            <button class="move-to-folder-btn">
                                <span class="menu-icon">ğŸ“</span>
                                ç§»åŠ¨åˆ°æ–‡ä»¶å¤¹
                            </button>
                            <button class="delete-btn">
                                <span class="menu-icon">ğŸ—‘ï¸</span>
                                åˆ é™¤
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-block-content">
                ${isImageBlock ? 
                    `<img src="${block.content}" alt="${block.title}" style="max-width: 100%; border-radius: 6px; display: block; margin: 0 auto;">` : 
                    (block.content || '').replace(/\n/g, '<br>')
                }
            </div>
            <div class="text-block-footer">
                ${isImageBlock ? 
                    `<button class="share-image-btn">è½¬å‘å›¾ç‰‡</button>` : 
                    `<button class="copy-content-btn">å¤åˆ¶å†…å®¹</button>`
                }
            </div>
        `;
        
        // è®¾ç½®é€‰ä¸­çŠ¶æ€
        if (isSelected) {
            blockElement.classList.add('selected');
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        setupBlockEventListeners(blockElement, block, index);
        
        return blockElement;
    }

    // è®¾ç½®æ–‡æœ¬å—äº‹ä»¶ç›‘å¬
    function setupBlockEventListeners(blockElement, block, index) {
        const header = blockElement.querySelector('.text-block-header');
        const copyBtn = blockElement.querySelector('.copy-content-btn, .share-image-btn');
        const copyIcon = blockElement.querySelector('.action-icon.copy');
        const editIcon = blockElement.querySelector('.action-icon.edit');
        const moreIcon = blockElement.querySelector('.action-icon.more');
        const moreMenu = blockElement.querySelector('.more-menu');
        const moveTopBtn = blockElement.querySelector('.move-top-btn');
        const moveUpBtn = blockElement.querySelector('.move-up-btn');
        const moveDownBtn = blockElement.querySelector('.move-down-btn');
        const moveToFolderBtn = blockElement.querySelector('.move-to-folder-btn');
        const deleteBtn = blockElement.querySelector('.delete-btn');
        const checkbox = blockElement.querySelector('.checkbox');
        
        // å¤é€‰æ¡†ç‚¹å‡»äº‹ä»¶
        checkbox.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleBlockSelection(block.id); // ä½¿ç”¨block.id
        });
        
        // æŠ˜å /å±•å¼€
        header.addEventListener('click', (e) => {
            if (!e.target.closest('.text-block-actions') && !e.target.closest('.checkbox')) {
                blockElement.classList.toggle('collapsed');
            }
        });
        
        // å¤åˆ¶å†…å®¹
        if (copyBtn) {
            copyBtn.addEventListener('click', () => {
                if (block.type === 'image') {
                    openShareModal(block.content);
                } else {
                    copyToClipboard(block.content);
                }
            });
        }
        
        // å¤åˆ¶å›¾æ ‡
        copyIcon.addEventListener('click', () => {
            if (block.type === 'image') {
                openShareModal(block.content);
            } else {
                copyToClipboard(block.content);
            }
        });
        
        // ç¼–è¾‘
        editIcon.addEventListener('click', () => {
            editBlock(index);
        });
        
        // æ›´å¤šèœå•
        moreIcon.addEventListener('click', (e) => {
            e.stopPropagation();
            closeAllMoreMenus();
            const rect = moreIcon.getBoundingClientRect();
            moreMenu.style.display = 'block';
            moreMenu.style.top = `${rect.bottom + 5}px`;
            moreMenu.style.right = `${window.innerWidth - rect.right}px`;
        });
        
        // ç½®é¡¶åŠŸèƒ½
        moveTopBtn.addEventListener('click', () => {
            moveToTop(index);
            closeAllMoreMenus();
        });
        
        // ä¸Šç§»åŠŸèƒ½
        moveUpBtn.addEventListener('click', () => {
            moveUp(index);
            closeAllMoreMenus();
        });
        
        // ä¸‹ç§»åŠŸèƒ½
        moveDownBtn.addEventListener('click', () => {
            moveDown(index);
            closeAllMoreMenus();
        });
        
        // ç§»åŠ¨åˆ°æ–‡ä»¶å¤¹
        moveToFolderBtn.addEventListener('click', () => {
            movingBlockIndex = index;
            openMoveToFolderModal();
            closeAllMoreMenus();
        });
        
        // åˆ é™¤ - ç®€åŒ–ç¡®è®¤æµç¨‹
        deleteBtn.addEventListener('click', () => {
            deleteBlock(index);
            closeAllMoreMenus();
        });
    }

    // åˆ‡æ¢æ–‡æœ¬å—é€‰æ‹©çŠ¶æ€ - ä½¿ç”¨block.idè€Œä¸æ˜¯index
    function toggleBlockSelection(blockId) {
        if (!isMultiSelectMode) return;
        
        if (selectedBlocks.has(blockId)) {
            selectedBlocks.delete(blockId);
        } else {
            selectedBlocks.add(blockId);
        }
        updateMultiSelectUI();
    }

    // æ›´æ–°å¤šé€‰UI
    function updateMultiSelectUI() {
        const selectedCount = document.getElementById('selectedCount');
        selectedCount.textContent = selectedBlocks.size;
        
        // æ›´æ–°æ‰€æœ‰æ–‡æœ¬å—çš„é€‰ä¸­çŠ¶æ€
        document.querySelectorAll('.text-block').forEach(block => {
            const blockId = block.dataset.blockId;
            const checkbox = block.querySelector('.checkbox');
            if (selectedBlocks.has(blockId)) {
                block.classList.add('selected');
                checkbox.classList.add('checked');
            } else {
                block.classList.remove('selected');
                checkbox.classList.remove('checked');
            }
        });
        
        // æ˜¾ç¤º/éšè—å¤šé€‰å·¥å…·æ 
        const toolbar = document.getElementById('multiSelectToolbar');
        if (selectedBlocks.size > 0) {
            toolbar.style.display = 'flex';
        } else if (!isMultiSelectMode) {
            toolbar.style.display = 'none';
        }
    }

    // ç§»åŠ¨åŠŸèƒ½å®ç°
    function moveToTop(index) {
        if (index === 0) return;
        
        const blockToMove = textBlocks.splice(index, 1)[0];
        textBlocks.unshift(blockToMove);
        
        saveData();
        renderBlocks();
        showCopySuccess('å·²ç½®é¡¶');
    }

    function moveUp(index) {
        if (index === 0) return;
        
        const blockToMove = textBlocks.splice(index, 1)[0];
        textBlocks.splice(index - 1, 0, blockToMove);
        
        saveData();
        renderBlocks();
        showCopySuccess('å·²ä¸Šç§»');
    }

    function moveDown(index) {
        if (index === textBlocks.length - 1) return;
        
        const blockToMove = textBlocks.splice(index, 1)[0];
        textBlocks.splice(index + 1, 0, blockToMove);
        
        saveData();
        renderBlocks();
        showCopySuccess('å·²ä¸‹ç§»');
    }

    // å…³é—­æ‰€æœ‰æ›´å¤šèœå•
    function closeAllMoreMenus() {
        document.querySelectorAll('.more-menu').forEach(menu => {
            menu.style.display = 'none';
        });
        closeFolderActionsMenu();
    }

    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
        // æ•°æ®å¤‡ä»½
        document.getElementById('setupSyncBtn').addEventListener('click', openExportModal);
        
        // åº•éƒ¨å·¥å…·æ 
        document.getElementById('floatingAddBlockBtn').addEventListener('click', () => openModal());
        document.getElementById('floatingAddImageBtn').addEventListener('click', () => openImageModal());
        document.getElementById('floatingImportBtn').addEventListener('click', openImportModal);
        document.getElementById('floatingExportBtn').addEventListener('click', openExportModal);
        
        // å¿«é€Ÿæ“ä½œ
        document.getElementById('quickAddFolder').addEventListener('click', openFolderModal);
        document.getElementById('togglePinFolder').addEventListener('click', startTogglePinFolder);
        document.getElementById('editFolderBtn').addEventListener('click', startEditFolder);
        document.getElementById('deleteFolderBtn').addEventListener('click', startDeleteFolder);
        document.getElementById('multiSelectBtn').addEventListener('click', toggleMultiSelectMode);
        
        // å¤šé€‰æ“ä½œ
        document.getElementById('moveSelectedBtn').addEventListener('click', moveSelectedBlocks);
        document.getElementById('deleteSelectedBtn').addEventListener('click', deleteSelectedBlocks);
        document.getElementById('cancelSelectBtn').addEventListener('click', cancelMultiSelect);
        
        // æ–‡ä»¶å¤¹æ“ä½œèœå•
        document.getElementById('folderActionsMenu').querySelector('.pin-folder-btn').addEventListener('click', () => {
            if (selectedFolderId) pinFolder(selectedFolderId);
        });
        document.getElementById('folderActionsMenu').querySelector('.unpin-folder-btn').addEventListener('click', () => {
            if (selectedFolderId) unpinFolder(selectedFolderId);
        });
        document.getElementById('folderActionsMenu').querySelector('.rename-folder-btn').addEventListener('click', () => {
            if (selectedFolderId) renameFolder(selectedFolderId);
        });
        document.getElementById('folderActionsMenu').querySelector('.delete-folder-btn').addEventListener('click', deleteSelectedFolder);
        
        // å›¾ç‰‡ç›¸å…³äº‹ä»¶
        document.getElementById('imageUploadArea').addEventListener('click', () => document.getElementById('imageFile').click());
        document.getElementById('imageFile').addEventListener('change', handleImageUpload);
        document.getElementById('saveImageBtn').addEventListener('click', saveImage);
        document.getElementById('cancelImageBtn').addEventListener('click', closeImageModal);
        document.getElementById('closeShareBtn').addEventListener('click', closeShareModal);
        
        // å¯¼å…¥å¯¼å‡ºäº‹ä»¶
        document.getElementById('copyExportBtn').addEventListener('click', copyExportData);
        document.getElementById('closeExportBtn').addEventListener('click', closeExportModal);
        document.getElementById('confirmImportBtn').addEventListener('click', confirmImport);
        document.getElementById('closeImportBtn').addEventListener('click', closeImportModal);
        
        // æ–‡ä»¶å¤¹åŒºåŸŸå±•å¼€/æ”¶èµ·
        document.getElementById('expandToggle').addEventListener('click', toggleFoldersExpand);
        
        // æ¨¡æ€æ¡†
        document.getElementById('saveBtn').addEventListener('click', saveBlock);
        document.getElementById('cancelBtn').addEventListener('click', closeModal);
        document.getElementById('saveFolderBtn').addEventListener('click', saveFolder);
        document.getElementById('cancelFolderBtn').addEventListener('click', closeFolderModal);
        
        // æœç´¢
        document.getElementById('searchInput').addEventListener('input', renderBlocks);
        
        // æœç´¢é€‰é¡¹å¡
        document.querySelectorAll('.search-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                const tabType = e.target.getAttribute('data-tab');
                switchSearchTab(tabType);
            });
        });
        
        // æ–°å»ºæ–‡ä»¶å¤¹æŒ‰é’®
        document.getElementById('addFolderBtn').addEventListener('click', openFolderModal);
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });

        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­æ›´å¤šèœå•
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.more-actions') && !e.target.closest('.folder-actions-menu')) {
                closeAllMoreMenus();
            }
        });
    }

    // å¤šé€‰æ¨¡å¼åˆ‡æ¢
    function toggleMultiSelectMode() {
        isMultiSelectMode = !isMultiSelectMode;
        const multiSelectBtn = document.getElementById('multiSelectBtn');
        
        if (isMultiSelectMode) {
            // è¿›å…¥å¤šé€‰æ¨¡å¼
            multiSelectBtn.textContent = 'âŒ å…³é—­å¤šé€‰';
            multiSelectBtn.classList.add('active');
            document.body.classList.add('multi-select-mode');
            document.getElementById('multiSelectToolbar').style.display = 'flex';
        } else {
            // é€€å‡ºå¤šé€‰æ¨¡å¼
            multiSelectBtn.textContent = 'â˜‘ï¸ å¼€å¯å¤šé€‰';
            multiSelectBtn.classList.remove('active');
            document.body.classList.remove('multi-select-mode');
            selectedBlocks.clear();
            document.getElementById('multiSelectToolbar').style.display = 'none';
        }
        updateMultiSelectUI();
    }

    // ç§»åŠ¨é€‰ä¸­çš„æ–‡æœ¬å—
    function moveSelectedBlocks() {
        if (selectedBlocks.size === 0) {
            showCopySuccess('è¯·å…ˆé€‰æ‹©è¦ç§»åŠ¨çš„å†…å®¹');
            return;
        }
        
        openMultiMoveToFolderModal();
    }

    // åˆ é™¤é€‰ä¸­çš„æ–‡æœ¬å—
    function deleteSelectedBlocks() {
        if (selectedBlocks.size === 0) {
            showCopySuccess('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å†…å®¹');
            return;
        }
        
        // ç®€åŒ–ç¡®è®¤æµç¨‹ - ç›´æ¥åˆ é™¤
        // æ‰¾åˆ°æ‰€æœ‰é€‰ä¸­çš„æ–‡æœ¬å—ç´¢å¼•
        const indicesToDelete = [];
        textBlocks.forEach((block, index) => {
            if (selectedBlocks.has(block.id)) {
                indicesToDelete.push(index);
            }
        });
        
        // æŒ‰ç´¢å¼•ä»å¤§åˆ°å°åˆ é™¤ï¼Œé¿å…ç´¢å¼•å˜åŒ–
        indicesToDelete.sort((a, b) => b - a).forEach(index => {
            textBlocks.splice(index, 1);
        });
        
        selectedBlocks.clear();
        saveData();
        renderBlocks();
        renderFolders();
        showCopySuccess(`å·²åˆ é™¤ ${indicesToDelete.length} æ¡å†…å®¹`);
        updateMultiSelectUI();
    }

    // å–æ¶ˆå¤šé€‰
    function cancelMultiSelect() {
        selectedBlocks.clear();
        isMultiSelectMode = false;
        document.getElementById('multiSelectToolbar').style.display = 'none';
        document.body.classList.remove('multi-select-mode');
        const multiSelectBtn = document.getElementById('multiSelectBtn');
        multiSelectBtn.textContent = 'â˜‘ï¸ å¼€å¯å¤šé€‰';
        multiSelectBtn.classList.remove('active');
        updateMultiSelectUI();
    }

    // å¼€å§‹åˆ‡æ¢ç½®é¡¶çŠ¶æ€
    function startTogglePinFolder() {
        if (folders.length === 0) {
            showCopySuccess('æ²¡æœ‰å¯æ“ä½œçš„æ–‡ä»¶å¤¹');
            return;
        }
        
        // è®©ç”¨æˆ·é€‰æ‹©è¦æ“ä½œçš„æ–‡ä»¶å¤¹
        const folderNames = folders.map(f => f.name).join('\n');
        const folderName = prompt(`è¯·é€‰æ‹©è¦åˆ‡æ¢ç½®é¡¶çš„æ–‡ä»¶å¤¹ï¼ˆè¾“å…¥å‡†ç¡®åç§°ï¼‰ï¼š\n\n${folderNames}`);
        if (!folderName) return;
        
        const folder = folders.find(f => f.name === folderName.trim());
        if (!folder) {
            showCopySuccess('æœªæ‰¾åˆ°æŒ‡å®šæ–‡ä»¶å¤¹');
            return;
        }
        
        togglePinFolder(folder.id);
    }

    // å¼€å§‹ç¼–è¾‘æ–‡ä»¶å¤¹
    function startEditFolder() {
        if (folders.length === 0) {
            showCopySuccess('æ²¡æœ‰å¯ç¼–è¾‘çš„æ–‡ä»¶å¤¹');
            return;
        }
        
        // è®©ç”¨æˆ·é€‰æ‹©è¦ç¼–è¾‘çš„æ–‡ä»¶å¤¹
        const folderNames = folders.map(f => f.name).join('\n');
        const folderName = prompt(`è¯·é€‰æ‹©è¦ç¼–è¾‘çš„æ–‡ä»¶å¤¹ï¼ˆè¾“å…¥å‡†ç¡®åç§°ï¼‰ï¼š\n\n${folderNames}`);
        if (!folderName) return;
        
        const folder = folders.find(f => f.name === folderName.trim());
        if (!folder) {
            showCopySuccess('æœªæ‰¾åˆ°æŒ‡å®šæ–‡ä»¶å¤¹');
            return;
        }
        
        renameFolder(folder.id);
    }

    // å¼€å§‹åˆ é™¤æ–‡ä»¶å¤¹
    function startDeleteFolder() {
        if (folders.length === 0) {
            showCopySuccess('æ²¡æœ‰å¯åˆ é™¤çš„æ–‡ä»¶å¤¹');
            return;
        }
        
        // è®©ç”¨æˆ·é€‰æ‹©è¦åˆ é™¤çš„æ–‡ä»¶å¤¹
        const folderNames = folders.map(f => f.name).join('\n');
        const folderName = prompt(`è¯·é€‰æ‹©è¦åˆ é™¤çš„æ–‡ä»¶å¤¹ï¼ˆè¾“å…¥å‡†ç¡®åç§°ï¼‰ï¼š\n\n${folderNames}`);
        if (!folderName) return;
        
        const folder = folders.find(f => f.name === folderName.trim());
        if (!folder) {
            showCopySuccess('æœªæ‰¾åˆ°æŒ‡å®šæ–‡ä»¶å¤¹');
            return;
        }
        
        selectedFolderId = folder.id;
        deleteSelectedFolder();
    }

    // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (!file.type.startsWith('image/')) {
            alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = e => {
            currentImageData = e.target.result;
            const preview = document.getElementById('imagePreview');
            const previewContainer = document.getElementById('imagePreviewContainer');
            preview.src = currentImageData;
            previewContainer.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }

    // ä¿å­˜å›¾ç‰‡
    function saveImage() {
        const title = document.getElementById('imageTitle').value.trim();
        const folder = document.getElementById('imageFolder').value;
        
        if (!title) {
            alert('è¯·è¾“å…¥å›¾ç‰‡æ ‡é¢˜');
            return;
        }
        
        if (!currentImageData) {
            alert('è¯·é€‰æ‹©å›¾ç‰‡');
            return;
        }
        
        const block = {
            id: Date.now().toString(),
            title: title,
            content: currentImageData,
            type: 'image',
            folder: folder,
            createdAt: new Date().toISOString()
        };
        
        if (editingIndex === -1) {
            textBlocks.unshift(block);
        } else {
            block.id = textBlocks[editingIndex].id;
            block.createdAt = textBlocks[editingIndex].createdAt;
            textBlocks[editingIndex] = block;
        }
        
        saveData();
        renderBlocks();
        renderFolders();
        closeImageModal();
        
        showCopySuccess(editingIndex === -1 ? 'å›¾ç‰‡å·²æ·»åŠ ' : 'å›¾ç‰‡å·²æ›´æ–°');
    }

    // æ‰“å¼€å›¾ç‰‡åˆ†äº«æ¨¡æ€æ¡†
    function openShareModal(imageData) {
        document.getElementById('shareImagePreview').src = imageData;
        document.getElementById('shareModal').style.display = 'flex';
    }

    // å¯¼å‡ºæ•°æ®
    function openExportModal() {
        const exportData = document.getElementById('exportData');
        // åªå¯¼å‡ºæ–‡æœ¬å—æ•°æ®ï¼Œä¸åŒ…å«å›¾ç‰‡æ•°æ®
        const textBlocksToExport = textBlocks.filter(block => block.type !== 'image');
        const dataToExport = {
            textBlocks: textBlocksToExport,
            folders: folders,
            exportTime: new Date().toISOString(),
            version: '1.0'
        };
        exportData.value = JSON.stringify(dataToExport, null, 2);
        document.getElementById('exportModal').style.display = 'flex';
    }

    // å¯¼å…¥æ•°æ®
    function openImportModal() {
        document.getElementById('importModal').style.display = 'flex';
    }

    // å¤åˆ¶å¯¼å‡ºæ•°æ®
    function copyExportData() {
        const exportData = document.getElementById('exportData');
        exportData.select();
        document.execCommand('copy');
        showCopySuccess('å¯¼å‡ºæ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    }

    // ç¡®è®¤å¯¼å…¥
    function confirmImport() {
        const importData = document.getElementById('importData').value.trim();
        
        if (!importData) {
            alert('è¯·è¾“å…¥è¦å¯¼å…¥çš„æ•°æ®');
            return;
        }
        
        try {
            const parsedData = JSON.parse(importData);
            
            // éªŒè¯æ•°æ®æ ¼å¼
            if (parsedData.textBlocks && Array.isArray(parsedData.textBlocks)) {
                if (confirm('ç¡®å®šè¦å¯¼å…¥æ•°æ®å—ï¼Ÿå½“å‰æ•°æ®å°†è¢«è¦†ç›–ã€‚')) {
                    textBlocks = parsedData.textBlocks;
                    folders = parsedData.folders || [];
                    
                    saveData();
                    renderFolders();
                    renderBlocks();
                    updateFolderSelects();
                    
                    showCopySuccess('æ•°æ®å¯¼å…¥æˆåŠŸ');
                    closeImportModal();
                }
            } else {
                alert('å¯¼å…¥æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
            }
        } catch (error) {
            alert('å¯¼å…¥æ•°æ®æ ¼å¼é”™è¯¯: ' + error.message);
        }
    }

    // åˆ‡æ¢æ–‡ä»¶å¤¹åŒºåŸŸå±•å¼€/æ”¶èµ·
    function toggleFoldersExpand() {
        const foldersSection = document.getElementById('foldersSection');
        const expandToggle = document.getElementById('expandToggle');
        
        foldersSection.classList.toggle('expanded');
        expandToggle.textContent = foldersSection.classList.contains('expanded') ? 'æ”¶èµ·' : 'å±•å¼€';
    }

    // åˆ‡æ¢æœç´¢é€‰é¡¹å¡
    function switchSearchTab(tabType) {
        document.querySelectorAll('.search-tab').forEach(tab => {
            tab.classList.toggle('active', tab.getAttribute('data-tab') === tabType);
        });
        
        if (tabType === 'content') {
            document.getElementById('contentSearchContainer').style.display = 'block';
            document.getElementById('foldersSearchContainer').style.display = 'none';
        } else {
            document.getElementById('contentSearchContainer').style.display = 'none';
            document.getElementById('foldersSearchContainer').style.display = 'block';
        }
    }

    // æ›´æ–°æ–‡ä»¶å¤¹é€‰æ‹©å™¨
    function updateFolderSelects() {
        const folderSelects = document.querySelectorAll('#blockFolder, #imageFolder');
        
        folderSelects.forEach(select => {
            select.innerHTML = '<option value="all">å…¨éƒ¨</option>';
            
            folders.forEach(folder => {
                const option = document.createElement('option');
                option.value = folder.id;
                option.textContent = folder.name;
                select.appendChild(option);
            });
        });
    }

    // ä¿å­˜æ•°æ®
    function saveData() {
        localStorage.setItem('wechatQuickReplies', JSON.stringify(textBlocks));
        localStorage.setItem('wechatFolders', JSON.stringify(folders));
    }

    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showCopySuccess();
        }).catch(err => {
            // é™çº§æ–¹æ¡ˆ
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showCopySuccess();
        });
    }

    // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
    function showCopySuccess(message = 'âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿') {
        const copySuccess = document.getElementById('copySuccess');
        copySuccess.textContent = message;
        copySuccess.style.display = 'block';
        
        setTimeout(() => {
            copySuccess.style.display = 'none';
        }, 2000);
    }

    // æ¨¡æ€æ¡†å‡½æ•°
    function openModal(index = -1) {
        editingIndex = index;
        const modal = document.getElementById('blockModal');
        const title = document.getElementById('modalTitle');
        const blockTitle = document.getElementById('blockTitle');
        const blockContent = document.getElementById('blockContent');
        const blockFolder = document.getElementById('blockFolder');
        
        if (index === -1) {
            title.textContent = 'æ–°å»ºè¯æœ¯';
            blockTitle.value = '';
            blockContent.value = '';
            blockFolder.value = 'all';
        } else {
            title.textContent = 'ç¼–è¾‘è¯æœ¯';
            const block = textBlocks[index];
            blockTitle.value = block.title;
            blockContent.value = block.content;
            blockFolder.value = block.folder || 'all';
        }
        
        modal.style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('blockModal').style.display = 'none';
        editingIndex = -1;
    }

    function openImageModal(index = -1) {
        editingIndex = index;
        const modal = document.getElementById('imageModal');
        const imageTitle = document.getElementById('imageTitle');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        
        if (index === -1) {
            imageTitle.value = '';
            currentImageData = null;
            imagePreviewContainer.style.display = 'none';
        } else {
            const block = textBlocks[index];
            imageTitle.value = block.title;
            currentImageData = block.content;
            imagePreviewContainer.style.display = 'block';
            document.getElementById('imagePreview').src = block.content;
        }
        
        modal.style.display = 'flex';
    }

    function closeImageModal() {
        document.getElementById('imageModal').style.display = 'none';
        editingIndex = -1;
        currentImageData = null;
        document.getElementById('imageFile').value = '';
        document.getElementById('imagePreviewContainer').style.display = 'none';
    }

    function closeShareModal() {
        document.getElementById('shareModal').style.display = 'none';
    }

    function closeExportModal() {
        document.getElementById('exportModal').style.display = 'none';
    }

    function closeImportModal() {
        document.getElementById('importModal').style.display = 'none';
        document.getElementById('importData').value = '';
    }

    function openFolderModal() {
        editingFolderId = null;
        document.getElementById('folderName').value = '';
        document.getElementById('pinFolder').checked = false; // é»˜è®¤ä¸ç½®é¡¶
        document.getElementById('folderModalTitle').textContent = 'æ–°å»ºæ–‡ä»¶å¤¹';
        document.getElementById('folderModal').style.display = 'flex';
    }

    function closeFolderModal() {
        document.getElementById('folderModal').style.display = 'none';
        editingFolderId = null;
    }

    function openMoveToFolderModal() {
        // åˆ›å»ºç§»åŠ¨åˆ°æ–‡ä»¶å¤¹æ¨¡æ€æ¡†
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'flex';
        
        modal.innerHTML = `
            <div class="modal-content">
                <h2>ç§»åŠ¨åˆ°æ–‡ä»¶å¤¹</h2>
                <div class="form-group">
                    <label for="targetFolder">é€‰æ‹©ç›®æ ‡æ–‡ä»¶å¤¹</label>
                    <select id="targetFolder">
                        <option value="all">å…¨éƒ¨</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button id="cancelMoveBtn">å–æ¶ˆ</button>
                    <button id="confirmMoveBtn">ç¡®è®¤ç§»åŠ¨</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // å¡«å……æ–‡ä»¶å¤¹é€‰é¡¹
        const targetFolder = modal.querySelector('#targetFolder');
        folders.forEach(folder => {
            const option = document.createElement('option');
            option.value = folder.id;
            option.textContent = folder.name;
            targetFolder.appendChild(option);
        });
        
        // å–æ¶ˆæŒ‰é’®
        modal.querySelector('#cancelMoveBtn').addEventListener('click', () => {
            modal.remove();
        });
        
        // ç¡®è®¤ç§»åŠ¨æŒ‰é’®
        modal.querySelector('#confirmMoveBtn').addEventListener('click', () => {
            const targetFolderId = targetFolder.value;
            if (movingBlockIndex !== -1 && targetFolderId) {
                textBlocks[movingBlockIndex].folder = targetFolderId;
                saveData();
                renderBlocks();
                renderFolders();
                modal.remove();
                showCopySuccess('å·²ç§»åŠ¨åˆ°æ–‡ä»¶å¤¹');
            }
        });
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }

    function openMultiMoveToFolderModal() {
        // åˆ›å»ºå¤šé€‰ç§»åŠ¨åˆ°æ–‡ä»¶å¤¹æ¨¡æ€æ¡†
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'flex';
        
        modal.innerHTML = `
            <div class="modal-content">
                <h2>ç§»åŠ¨é€‰ä¸­å†…å®¹åˆ°æ–‡ä»¶å¤¹</h2>
                <div class="form-group">
                    <label for="multiTargetFolder">é€‰æ‹©ç›®æ ‡æ–‡ä»¶å¤¹</label>
                    <select id="multiTargetFolder">
                        <option value="all">å…¨éƒ¨</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button id="cancelMultiMoveBtn">å–æ¶ˆ</button>
                    <button id="confirmMultiMoveBtn">ç¡®è®¤ç§»åŠ¨</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // å¡«å……æ–‡ä»¶å¤¹é€‰é¡¹
        const targetFolder = modal.querySelector('#multiTargetFolder');
        folders.forEach(folder => {
            const option = document.createElement('option');
            option.value = folder.id;
            option.textContent = folder.name;
            targetFolder.appendChild(option);
        });
        
        // å–æ¶ˆæŒ‰é’®
        modal.querySelector('#cancelMultiMoveBtn').addEventListener('click', () => {
            modal.remove();
        });
        
        // ç¡®è®¤ç§»åŠ¨æŒ‰é’®
        modal.querySelector('#confirmMultiMoveBtn').addEventListener('click', () => {
            const targetFolderId = targetFolder.value;
            if (selectedBlocks.size > 0 && targetFolderId) {
                // ç§»åŠ¨æ‰€æœ‰é€‰ä¸­çš„æ–‡æœ¬å—
                const selectedCount = selectedBlocks.size;
                textBlocks.forEach(block => {
                    if (selectedBlocks.has(block.id)) {
                        block.folder = targetFolderId;
                    }
                });
                
                saveData();
                renderBlocks();
                renderFolders();
                selectedBlocks.clear();
                updateMultiSelectUI();
                modal.remove();
                showCopySuccess(`å·²ç§»åŠ¨ ${selectedCount} æ¡å†…å®¹åˆ°æ–‡ä»¶å¤¹`);
            }
        });
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }

    // ä¿å­˜æ–‡æœ¬å—
    function saveBlock() {
        const title = document.getElementById('blockTitle').value.trim();
        const content = document.getElementById('blockContent').value.trim();
        const folder = document.getElementById('blockFolder').value;
        
        if (!title) {
            alert('è¯·è¾“å…¥è¯æœ¯æ ‡é¢˜');
            return;
        }
        
        if (!content) {
            alert('è¯·è¾“å…¥å›å¤å†…å®¹');
            return;
        }
        
        const block = {
            id: Date.now().toString(),
            title: title,
            content: content,
            type: 'text',
            folder: folder,
            createdAt: new Date().toISOString()
        };
        
        if (editingIndex === -1) {
            textBlocks.unshift(block);
        } else {
            block.id = textBlocks[editingIndex].id;
            block.createdAt = textBlocks[editingIndex].createdAt;
            textBlocks[editingIndex] = block;
        }
        
        saveData();
        renderFolders();
        renderBlocks();
        closeModal();
        
        showCopySuccess(editingIndex === -1 ? 'è¯æœ¯å·²åˆ›å»º' : 'è¯æœ¯å·²æ›´æ–°');
    }

    // ä¿å­˜æ–‡ä»¶å¤¹
    function saveFolder() {
        const folderName = document.getElementById('folderName').value.trim();
        const pinFolder = document.getElementById('pinFolder').checked;
        
        if (!folderName) {
            alert('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°');
            return;
        }
        
        if (editingFolderId) {
            // ç¼–è¾‘æ–‡ä»¶å¤¹
            const folder = folders.find(f => f.id === editingFolderId);
            if (folder) {
                folder.name = folderName;
                folder.pinned = pinFolder;
                showCopySuccess(`æ–‡ä»¶å¤¹å·²${pinFolder ? 'ç½®é¡¶å¹¶' : ''}é‡å‘½åä¸º"${folderName}"`);
            }
        } else {
            // æ–°å»ºæ–‡ä»¶å¤¹
            const newFolder = {
                id: Date.now().toString(),
                name: folderName,
                pinned: pinFolder,
                order: 0
            };
            
            folders.unshift(newFolder);
            showCopySuccess(`"${folderName}"æ–‡ä»¶å¤¹å·²åˆ›å»º${pinFolder ? 'å¹¶ç½®é¡¶' : ''}`);
        }
        
        saveData();
        renderFolders();
        updateFolderSelects();
        closeFolderModal();
    }

    // ç¼–è¾‘æ–‡æœ¬å—
    function editBlock(index) {
        const block = textBlocks[index];
        if (block.type === 'image') {
            openImageModal(index);
        } else {
            openModal(index);
        }
    }

    // åˆ é™¤æ–‡æœ¬å— - ç®€åŒ–ç¡®è®¤æµç¨‹
    function deleteBlock(index) {
        textBlocks.splice(index, 1);
        saveData();
        renderFolders();
        renderBlocks();
        showCopySuccess('å†…å®¹å·²åˆ é™¤');
    }

    // åˆå§‹åŒ–åº”ç”¨
    init();
</script>
</body>
</html>